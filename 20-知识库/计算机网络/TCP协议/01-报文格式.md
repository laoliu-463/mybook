---
title: TCP 报文格式
type: concept
domain: [计算机网络]
tags: [TCP, 报文格式, 首部, 传输层]
source: study-vault-builder
created: 2026-02-08
status: draft
---

## TL;DR

- TCP 首部最小 20 字节，最大 60 字节（含选项）
- 关键字段：序列号、确认号、窗口大小、标志位
- 6 个标志位控制连接状态：SYN/ACK/FIN/RST/PSH/URG

---

## 报文结构

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          Source Port          |       Destination Port        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        Sequence Number                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Acknowledgment Number                      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Data |           |U|A|P|R|S|F|                               |
| Offset| Reserved  |R|C|S|S|Y|I|            Window             |
|       |           |G|K|H|T|N|N|                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|           Checksum            |         Urgent Pointer        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Options                    |    Padding    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                             Data                              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

---

## 核心字段详解

### 端口号（各 16 位）

| 字段 | 说明 |
|------|------|
| 源端口 | 发送方端口，临时分配（1024-65535） |
| 目的端口 | 接收方端口，知名端口如 80(HTTP)、443(HTTPS) |

### 序列号与确认号（各 32 位）

| 字段 | 说明 |
|------|------|
| Sequence Number | 本报文段数据首字节的序号 |
| Acknowledgment Number | 期望收到的下一个字节序号（ACK=1 时有效） |

> [!tip] 序列号作用
> - 保证数据按序到达
> - 检测丢包和重复
> - 初始值（ISN）随机生成，防止攻击

### 数据偏移（4 位）

首部长度，单位 4 字节。值范围 5-15，对应 20-60 字节。

### 标志位（6 位）

| 标志 | 含义 | 典型场景 |
|------|------|----------|
| **SYN** | 同步序列号 | 三次握手第 1、2 步 |
| **ACK** | 确认有效 | 除首个 SYN 外所有报文 |
| **FIN** | 释放连接 | 四次挥手 |
| **RST** | 重置连接 | 异常终止、拒绝非法报文 |
| **PSH** | 推送数据 | 要求接收方立即交付应用层 |
| **URG** | 紧急指针有效 | 配合紧急指针使用（少用） |

### 窗口大小（16 位）

接收方通告的接收窗口（rwnd），用于[[04-滑动窗口|流量控制]]。

最大值 65535 字节，可通过窗口缩放选项扩展。

### 校验和（16 位）

覆盖首部 + 数据 + 伪首部，检测传输错误。

---

## 常用选项字段

| 选项 | 长度 | 说明 |
|------|------|------|
| **MSS** | 4B | 最大报文段长度，三次握手时协商 |
| **Window Scale** | 3B | 窗口缩放因子，扩展窗口至 1GB |
| **SACK** | 可变 | 选择性确认，提升重传效率 |
| **Timestamp** | 10B | 时间戳，用于 RTT 计算和 PAWS |

---

## 粘包拆包问题

### 原因

TCP 是**字节流**协议，不保留消息边界：
- **粘包**：多个消息合并成一个 TCP 段
- **拆包**：一个消息被拆分到多个 TCP 段

### 解决方案

| 方案 | 示例 |
|------|------|
| 固定长度 | 每条消息固定 100 字节 |
| 分隔符 | 用 `\r\n` 分隔（HTTP/1.1） |
| 长度前缀 | 先发 4 字节长度，再发内容（Protobuf） |
| 应用层协议 | HTTP Content-Length / chunked |

---

## 面试追问

**Q: 为什么 TCP 首部最小 20 字节？**

> 5 个必需字段 × 4 字节 = 20 字节。数据偏移最小值为 5。

**Q: MSS 和 MTU 的区别？**

> MTU 是链路层最大传输单元（含 IP/TCP 首部），MSS = MTU - 40（去掉 IP 20B + TCP 20B）。以太网 MTU=1500，则 MSS=1460。

---

## 知识网络

- [[00-overview|TCP 协议总览]]
- [[02-三次握手]]
- [[04-滑动窗口]]

## References

- RFC 793 - TCP 规范
- 《TCP/IP 详解 卷1》第 17-18 章
